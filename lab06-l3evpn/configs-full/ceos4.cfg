hostname ceos4
!
service routing protocols model multi-agent
!
ip routing
!
! Anycast Gateway MAC (全 Leaf 共通)
ip virtual-router mac-address 00:1c:73:00:00:01
!
vrf instance TENANT_A
!
ip routing vrf TENANT_A
!
! VLAN 定義
! VLAN20: TENANT_A L2セグメント (Host2 接続)
! VLAN100: TENANT_A 専用 L3VNI transit VLAN
vlan 20,100
!
interface Loopback0
   ip address 4.4.4.4/32
!
interface Ethernet1
   no switchport
   description to-Spine1(ceos1)
   ip address 10.1.0.6/30
!
interface Ethernet2
   no switchport
   description to-Spine2(ceos2)
   ip address 10.2.0.6/30
!
interface Ethernet3
   description to-Host2(ceos6)
   switchport access vlan 20
!
! 分散ゲートウェイ SVI (Anycast Gateway)
interface Vlan20
   vrf TENANT_A
   ip address virtual 192.168.20.254/24
!
! L3VNI transit SVI (IP 不要、unnumbered で OK)
interface Vlan100
   vrf TENANT_A
   ip address unnumbered Loopback0
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   ! L2VNI マッピング
   vxlan vlan 20 vni 10020
   ! L3VNI マッピング (VRF -> VNI)
   vxlan vrf TENANT_A vni 50001
!
router bgp 65002
   router-id 4.4.4.4
   no bgp default ipv4-unicast
   !
   ! アンダーレイ用 peer-group (P2P eBGP)
   neighbor SPINE_UNDERLAY peer group
   neighbor SPINE_UNDERLAY send-community extended
   !
   ! オーバーレイ用 peer-group (Loopback 間 eBGP、EVPN のみ)
   neighbor SPINE_OVERLAY peer group
   neighbor SPINE_OVERLAY ebgp-multihop 3
   neighbor SPINE_OVERLAY update-source Loopback0
   neighbor SPINE_OVERLAY send-community extended
   !
   ! アンダーレイ eBGP ピア (Spine P2P リンク)
   neighbor 10.1.0.5 peer group SPINE_UNDERLAY
   neighbor 10.1.0.5 remote-as 65000
   neighbor 10.2.0.5 peer group SPINE_UNDERLAY
   neighbor 10.2.0.5 remote-as 65000
   !
   ! オーバーレイ EVPN eBGP ピア (Spine Loopback)
   neighbor 1.1.1.1 peer group SPINE_OVERLAY
   neighbor 1.1.1.1 remote-as 65000
   neighbor 2.2.2.2 peer group SPINE_OVERLAY
   neighbor 2.2.2.2 remote-as 65000
   !
   ! L2VNI EVPN 設定 (Type-2/3 MAC-IP ルート)
   vlan 20
      rd 4.4.4.4:10020
      route-target import 65002:10020
      route-target export 65002:10020
      redistribute learned
   !
   address-family ipv4
      neighbor SPINE_UNDERLAY activate
      network 4.4.4.4/32
   !
   address-family evpn
      neighbor SPINE_OVERLAY activate
   !
   ! L3VNI EVPN 設定 (Type-5 IP Prefix ルート)
   vrf TENANT_A
      rd 4.4.4.4:100
      route-target import evpn 100:100
      route-target export evpn 100:100
      redistribute connected
!
username admin privilege 15 role network-admin secret 0 admin
!
management api http-commands
   protocol http
   no shutdown
!
