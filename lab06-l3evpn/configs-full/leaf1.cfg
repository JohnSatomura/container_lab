hostname leaf1
!
service routing protocols model multi-agent
!
ip routing
!
! Anycast Gateway MAC (全 Leaf 共通)
ip virtual-router mac-address 00:1c:73:00:00:01
!
vrf instance TENANT_A
vrf instance TENANT_B
!
ip routing vrf TENANT_A
ip routing vrf TENANT_B
!
! VLAN 定義
! VLAN10: TENANT_A L2セグメント (Host1 接続)
! VLAN30: TENANT_B L2セグメント (Host3 接続)
! VLAN100: TENANT_A 専用 L3VNI transit VLAN
! VLAN110: TENANT_B 専用 L3VNI transit VLAN
vlan 10,30,100,110
!
interface Loopback0
   ip address 3.3.3.3/32
!
interface Ethernet1
   no switchport
   description to-Spine1(spine1)
   ip address 10.1.0.2/30
!
interface Ethernet2
   no switchport
   description to-Spine2(spine2)
   ip address 10.2.0.2/30
!
interface Ethernet3
   description to-Host1(host1)
   switchport access vlan 10
!
interface Ethernet4
   description to-Host3(host3)
   switchport access vlan 30
!
! 分散ゲートウェイ SVI (Anycast Gateway)
interface Vlan10
   vrf TENANT_A
   ip address virtual 192.168.10.254/24
!
interface Vlan30
   vrf TENANT_B
   ip address virtual 192.168.30.254/24
!
! L3VNI transit SVI (IP 不要、unnumbered で OK)
interface Vlan100
   vrf TENANT_A
   ip address unnumbered Loopback0
!
interface Vlan110
   vrf TENANT_B
   ip address unnumbered Loopback0
!
interface Vxlan1
   vxlan source-interface Loopback0
   vxlan udp-port 4789
   ! L2VNI マッピング
   vxlan vlan 10 vni 10010
   vxlan vlan 30 vni 10030
   ! L3VNI マッピング (VRF -> VNI)
   vxlan vrf TENANT_A vni 50001
   vxlan vrf TENANT_B vni 50002
!
router bgp 65001
   router-id 3.3.3.3
   no bgp default ipv4-unicast
   !
   ! アンダーレイ用 peer-group (P2P eBGP)
   neighbor SPINE_UNDERLAY peer group
   neighbor SPINE_UNDERLAY send-community extended
   !
   ! オーバーレイ用 peer-group (Loopback 間 eBGP、EVPN のみ)
   neighbor SPINE_OVERLAY peer group
   neighbor SPINE_OVERLAY ebgp-multihop 3
   neighbor SPINE_OVERLAY update-source Loopback0
   neighbor SPINE_OVERLAY send-community extended
   !
   ! アンダーレイ eBGP ピア (Spine P2P リンク)
   neighbor 10.1.0.1 peer group SPINE_UNDERLAY
   neighbor 10.1.0.1 remote-as 65000
   neighbor 10.2.0.1 peer group SPINE_UNDERLAY
   neighbor 10.2.0.1 remote-as 65000
   !
   ! オーバーレイ EVPN eBGP ピア (Spine Loopback)
   neighbor 1.1.1.1 peer group SPINE_OVERLAY
   neighbor 1.1.1.1 remote-as 65000
   neighbor 2.2.2.2 peer group SPINE_OVERLAY
   neighbor 2.2.2.2 remote-as 65000
   !
   ! L2VNI EVPN 設定 (Type-2/3 MAC-IP ルート)
   vlan 10
      rd 3.3.3.3:10010
      route-target import 65001:10010
      route-target export 65001:10010
      redistribute learned
   !
   vlan 30
      rd 3.3.3.3:10030
      route-target import 65001:10030
      route-target export 65001:10030
      redistribute learned
   !
   address-family ipv4
      neighbor SPINE_UNDERLAY activate
      network 3.3.3.3/32
   !
   address-family evpn
      neighbor SPINE_OVERLAY activate
   !
   ! L3VNI EVPN 設定 (Type-5 IP Prefix ルート)
   vrf TENANT_A
      rd 3.3.3.3:100
      route-target import evpn 100:100
      route-target export evpn 100:100
      redistribute connected
   !
   vrf TENANT_B
      rd 3.3.3.3:200
      route-target import evpn 200:200
      route-target export evpn 200:200
      redistribute connected
!
username admin privilege 15 role network-admin secret 0 admin
!
management api http-commands
   protocol http
   no shutdown
!
